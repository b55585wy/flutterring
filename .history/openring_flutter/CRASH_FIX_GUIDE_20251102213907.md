# ğŸ› ç¨‹åºå´©æºƒé—®é¢˜ä¿®å¤æŒ‡å—

**é—®é¢˜**: ç‚¹å‡»"å¼€å§‹æµ‹é‡"åç¨‹åºå´©æºƒ  
**æ—¥æœŸ**: 2025-10-31

---

## ğŸ“‹ é—®é¢˜æ ¹æºåˆ†æ

### 1. **ä¸»è¦é—®é¢˜ï¼šBLEService çŠ¶æ€æ£€æŸ¥ç¼ºå¤±**

```kotlin
// MainActivity.kt ç¬¬ 533-560 è¡Œ
private fun startLiveMeasurement(duration: Int, result: MethodChannel.Result) {
    try {
        // âŒ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥ BLEService æ˜¯å¦æ­£åœ¨è¿è¡Œ
        // âŒ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²è¿æ¥
        isMeasuring = true
        sampleBuffer.clear()
        
        // âŒ è¿™é‡Œç›´æ¥å‘é€å‘½ä»¤ï¼Œå¯èƒ½å¯¼è‡´å´©æºƒ
        BLEService.sendCmd(startCmd)
        
        result.success(null)
    } catch (e: Exception) {
        result.error("START_MEASUREMENT_ERROR", e.message, null)
    }
}
```

### 2. **å¯èƒ½çš„å´©æºƒåœºæ™¯**

**åœºæ™¯ A**: BLEService æœªå¯åŠ¨
- ç”¨æˆ·æ²¡æœ‰å…ˆè¿æ¥è®¾å¤‡å°±ç‚¹å‡»"å¼€å§‹æµ‹é‡"
- BLEService æ²¡æœ‰è¿è¡Œï¼Œå¹¿æ’­æ¥æ”¶å™¨æœªæ³¨å†Œ
- `BLEService.sendCmd()` å‘é€çš„å¹¿æ’­æ²¡æœ‰æ¥æ”¶è€…

**åœºæ™¯ B**: è®¾å¤‡æœªè¿æ¥
- è®¾å¤‡è™½ç„¶æ‰«æåˆ°äº†ï¼Œä½†è¿æ¥å¤±è´¥
- BLEService å¯åŠ¨äº†ï¼Œä½† BluetoothGatt ä¸º null
- å‘é€å‘½ä»¤æ—¶æ²¡æœ‰ GATT è¿æ¥

**åœºæ™¯ C**: å‘½ä»¤æ ¼å¼é”™è¯¯
- `0xC4` å‘½ä»¤å¯èƒ½ä¸æ˜¯æ­£ç¡®çš„å¯åŠ¨å‘½ä»¤
- è®¾å¤‡ä¸è¯†åˆ«è¯¥å‘½ä»¤ï¼Œè¿”å›é”™è¯¯

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ·»åŠ å®Œæ•´çš„çŠ¶æ€æ£€æŸ¥ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `MainActivity.kt` çš„ `startLiveMeasurement` æ–¹æ³•ï¼š

```kotlin
private var isConnected = false  // æ·»åŠ è¿æ¥çŠ¶æ€æ ‡å¿—

private fun handleConnectionStateChange(state: Int) {
    val stateString = when (state) {
        BLEService.CONNECT_STATE_SUCCESS -> {
            isConnected = true  // âœ… è¿æ¥æˆåŠŸæ—¶è®¾ç½®æ ‡å¿—
            "connected"
        }
        BLEService.CONNECT_STATE_DISCONNECTED -> {
            isConnected = false  // âœ… æ–­è¿æ—¶æ¸…é™¤æ ‡å¿—
            "disconnected"
        }
        BLEService.CONNECT_STATE_GATT_CONNECTING -> "connecting"
        else -> "unknown"
    }
    
    handler.post {
        sendEvent(mapOf(
            "type" to "connectionStateChanged",
            "state" to stateString,
            "statusCode" to state
        ))
    }
}

private fun startLiveMeasurement(duration: Int, result: MethodChannel.Result) {
    try {
        android.util.Log.d("OpenRing", "å¼€å§‹åœ¨çº¿æµ‹é‡ï¼Œæ—¶é•¿: $duration ç§’")
        
        // âœ… æ­¥éª¤ 1: æ£€æŸ¥è¿æ¥çŠ¶æ€
        if (!isConnected) {
            android.util.Log.e("OpenRing", "è®¾å¤‡æœªè¿æ¥ï¼Œæ— æ³•å¼€å§‹æµ‹é‡")
            result.error("NOT_CONNECTED", "Device not connected", null)
            return
        }
        
        // âœ… æ­¥éª¤ 2: æ£€æŸ¥ BLEService æ˜¯å¦è¿è¡Œ
        if (!isServiceRunning(BLEService::class.java)) {
            android.util.Log.e("OpenRing", "BLEService æœªè¿è¡Œ")
            result.error("SERVICE_NOT_RUNNING", "BLE Service is not running", null)
            return
        }
        
        // âœ… æ­¥éª¤ 3: è®¾ç½®æµ‹é‡çŠ¶æ€
        isMeasuring = true
        sampleBuffer.clear()
        
        // âœ… æ­¥éª¤ 4: å‘é€å¯åŠ¨æµ‹é‡å‘½ä»¤
        // æ³¨æ„ï¼šå‘½ä»¤å¯èƒ½éœ€è¦æ ¹æ®å®é™…åè®®è°ƒæ•´
        val startCmd = byteArrayOf(0xC4.toByte())
        BLEService.sendCmd(startCmd)
        
        android.util.Log.d("OpenRing", "å·²å‘é€å¯åŠ¨æµ‹é‡å‘½ä»¤")
        
        // âœ… æ­¥éª¤ 5: è®¾ç½®è‡ªåŠ¨åœæ­¢
        if (duration > 0) {
            handler.postDelayed({
                stopMeasurement(null)
            }, (duration * 1000).toLong())
        }
        
        result.success(null)
    } catch (e: Exception) {
        android.util.Log.e("OpenRing", "å¯åŠ¨æµ‹é‡å¤±è´¥: ${e.message}", e)
        isMeasuring = false
        result.error("START_MEASUREMENT_ERROR", e.message, null)
    }
}

// è¾…åŠ©æ–¹æ³•ï¼šæ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
private fun isServiceRunning(serviceClass: Class<*>): Boolean {
    val manager = getSystemService(Context.ACTIVITY_SERVICE) as android.app.ActivityManager
    @Suppress("DEPRECATION")
    for (service in manager.getRunningServices(Integer.MAX_VALUE)) {
        if (serviceClass.name == service.service.className) {
            return true
        }
    }
    return false
}
```

---

### æ–¹æ¡ˆ 2: æ”¹å–„ UI åé¦ˆï¼ˆé…åˆæ–¹æ¡ˆ 1ï¼‰

ä¿®æ”¹ `measurement_page.dart`ï¼Œåœ¨å¼€å§‹æµ‹é‡å‰æ£€æŸ¥è¿æ¥çŠ¶æ€ï¼š

```dart
// æ·»åŠ è¿æ¥çŠ¶æ€ç›‘å¬
bool _isConnected = false;
StreamSubscription<BleEvent>? _connectionSubscription;

@override
void initState() {
  super.initState();
  
  // ç›‘å¬è¿æ¥çŠ¶æ€
  _connectionSubscription = RingPlatform.eventStream.listen((event) {
    event.maybeWhen(
      connectionStateChanged: (state, name, address) {
        setState(() {
          _isConnected = (state == ConnectionState.connected);
        });
      },
      orElse: () {},
    );
  });
}

// ä¿®æ”¹å¼€å§‹æµ‹é‡æŒ‰é’®
Widget _buildControlButton(...) {
  return ElevatedButton(
    // âœ… æœªè¿æ¥æ—¶ç¦ç”¨æŒ‰é’®
    onPressed: (!_isRecording && _isConnected) ? () async {
      // æ˜¾ç¤ºæ—¶é•¿é€‰æ‹©å¯¹è¯æ¡†
      final duration = await _showDurationDialog();
      if (duration != null) {
        try {
          await RingPlatform.startLiveMeasurement(duration: duration);
          setState(() => _isRecording = true);
        } catch (e) {
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text('å¯åŠ¨æµ‹é‡å¤±è´¥: $e'),
                backgroundColor: Colors.red,
              ),
            );
          }
        }
      }
    } : null,  // âœ… æœªè¿æ¥æ—¶ç¦ç”¨
    child: Text(_isConnected ? 'å¼€å§‹æµ‹é‡' : 'è¯·å…ˆè¿æ¥è®¾å¤‡'),
  );
}

// æ·»åŠ æ—¶é•¿é€‰æ‹©å¯¹è¯æ¡†
Future<int?> _showDurationDialog() async {
  return showDialog<int>(
    context: context,
    builder: (context) => AlertDialog(
      title: const Text('é€‰æ‹©æµ‹é‡æ—¶é•¿'),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          _buildDurationOption('30 ç§’', 30),
          _buildDurationOption('1 åˆ†é’Ÿ', 60),
          _buildDurationOption('2 åˆ†é’Ÿ', 120),
          _buildDurationOption('5 åˆ†é’Ÿ', 300),
        ],
      ),
    ),
  );
}

Widget _buildDurationOption(String label, int seconds) {
  return ListTile(
    title: Text(label),
    onTap: () => Navigator.pop(context, seconds),
  );
}
```

---

### æ–¹æ¡ˆ 3: éªŒè¯å‘½ä»¤æ˜¯å¦æ­£ç¡®

éœ€è¦ç¡®è®¤ `0xC4` æ˜¯å¦æ˜¯æ­£ç¡®çš„å¯åŠ¨å‘½ä»¤ã€‚è®©æˆ‘ä»¬æŸ¥çœ‹åŸé¡¹ç›®çš„å‘½ä»¤å®šä¹‰ï¼š

```bash
# åœ¨åŸé¡¹ç›®ä¸­æœç´¢å¯åŠ¨æµ‹é‡çš„å‘½ä»¤
grep -r "0xC4\|0xC5" app/src/main/java/
```

å¦‚æœå‘½ä»¤ä¸æ­£ç¡®ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ LmAPI æä¾›çš„æ–¹æ³•ï¼š

```kotlin
// æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨ LmAPI å¯åŠ¨æµ‹é‡
private fun startLiveMeasurement(duration: Int, result: MethodChannel.Result) {
    try {
        if (!isConnected) {
            result.error("NOT_CONNECTED", "Device not connected", null)
            return
        }
        
        // âœ… ä½¿ç”¨ LmAPI çš„æ–¹æ³•ï¼ˆå¦‚æœæœ‰ï¼‰
        // LmAPI.startRealTimeData() // éœ€è¦ç¡®è®¤æ–¹æ³•å
        
        // æˆ–è€…ä½¿ç”¨æ­£ç¡®çš„å‘½ä»¤æ ¼å¼
        val cmd = CMDUtils.createStartMeasurementCmd(duration)  // å‡è®¾æœ‰è¿™æ ·çš„å·¥å…·ç±»
        BLEService.sendCmd(cmd)
        
        isMeasuring = true
        result.success(null)
    } catch (e: Exception) {
        result.error("START_MEASUREMENT_ERROR", e.message, null)
    }
}
```

---

## ğŸ” è°ƒè¯•æ­¥éª¤

### æ­¥éª¤ 1: æŸ¥çœ‹å´©æºƒæ—¥å¿—

1. åœ¨ Android Studio ä¸­æ‰“å¼€ Logcat
2. è®¾ç½®è¿‡æ»¤å™¨ï¼š`OpenRing|AndroidRuntime|FATAL`
3. ç‚¹å‡»"å¼€å§‹æµ‹é‡"æŒ‰é’®
4. å¤åˆ¶å®Œæ•´çš„å´©æºƒå †æ ˆä¿¡æ¯

**é¢„æœŸçœ‹åˆ°çš„æ—¥å¿—**ï¼š
```
E/AndroidRuntime: FATAL EXCEPTION: main
    Process: com.tsinghua.openring_flutter, PID: xxxxx
    java.lang.NullPointerException: ...
        at com.tsinghua.openring.utils.BLEService.sendCmd(BLEService.java:xxx)
        at com.tsinghua.openring_flutter.MainActivity.startLiveMeasurement(MainActivity.kt:544)
        ...
```

### æ­¥éª¤ 2: æ·»åŠ è¯¦ç»†æ—¥å¿—

åœ¨ `MainActivity.kt` ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```kotlin
private fun startLiveMeasurement(duration: Int, result: MethodChannel.Result) {
    android.util.Log.d("OpenRing", "========== å¼€å§‹æµ‹é‡ ==========")
    android.util.Log.d("OpenRing", "æ—¶é•¿: $duration ç§’")
    android.util.Log.d("OpenRing", "è¿æ¥çŠ¶æ€: $isConnected")
    android.util.Log.d("OpenRing", "æµ‹é‡çŠ¶æ€: $isMeasuring")
    
    try {
        if (!isConnected) {
            android.util.Log.e("OpenRing", "âŒ è®¾å¤‡æœªè¿æ¥")
            result.error("NOT_CONNECTED", "Device not connected", null)
            return
        }
        
        android.util.Log.d("OpenRing", "âœ… è®¾å¤‡å·²è¿æ¥ï¼Œå‡†å¤‡å‘é€å‘½ä»¤")
        
        isMeasuring = true
        sampleBuffer.clear()
        
        val startCmd = byteArrayOf(0xC4.toByte())
        android.util.Log.d("OpenRing", "å‘é€å‘½ä»¤: ${startCmd.joinToString(" ") { "%02X".format(it) }}")
        
        BLEService.sendCmd(startCmd)
        
        android.util.Log.d("OpenRing", "âœ… å‘½ä»¤å·²å‘é€")
        
        result.success(null)
    } catch (e: Exception) {
        android.util.Log.e("OpenRing", "âŒ å¯åŠ¨æµ‹é‡å¼‚å¸¸", e)
        android.util.Log.e("OpenRing", "å¼‚å¸¸ç±»å‹: ${e.javaClass.name}")
        android.util.Log.e("OpenRing", "å¼‚å¸¸æ¶ˆæ¯: ${e.message}")
        e.printStackTrace()
        
        isMeasuring = false
        result.error("START_MEASUREMENT_ERROR", e.message, e.stackTraceToString())
    }
}
```

### æ­¥éª¤ 3: éªŒè¯è¿æ¥çŠ¶æ€

åœ¨ç‚¹å‡»"å¼€å§‹æµ‹é‡"å‰ï¼Œå…ˆç¡®è®¤ï¼š

1. **è®¾å¤‡æ˜¯å¦å·²è¿æ¥**
   - åœ¨ä¸»é¡µç‚¹å‡»"æ‰«æè®¾å¤‡"
   - æ‰¾åˆ°æˆ’æŒ‡å¹¶ç‚¹å‡»è¿æ¥
   - ç­‰å¾…è¿æ¥çŠ¶æ€å˜ä¸º"å·²è¿æ¥"

2. **BLEService æ˜¯å¦è¿è¡Œ**
   ```kotlin
   // æ·»åŠ æ—¥å¿—æŸ¥çœ‹
   android.util.Log.d("OpenRing", "BLEService è¿è¡ŒçŠ¶æ€: ${isServiceRunning(BLEService::class.java)}")
   ```

3. **BluetoothGatt æ˜¯å¦å·²å»ºç«‹**
   ```kotlin
   // åœ¨ BLEService ä¸­æ·»åŠ çŠ¶æ€æ£€æŸ¥
   android.util.Log.d("BLEService", "mBluetoothGatt: ${mBluetoothGatt != null}")
   ```

---

## ğŸ“ å®Œæ•´ä¿®å¤æ¸…å•

- [ ] 1. åœ¨ `MainActivity.kt` æ·»åŠ  `isConnected` çŠ¶æ€æ ‡å¿—
- [ ] 2. åœ¨ `handleConnectionStateChange` ä¸­æ›´æ–°è¿æ¥çŠ¶æ€
- [ ] 3. åœ¨ `startLiveMeasurement` ä¸­æ·»åŠ è¿æ¥çŠ¶æ€æ£€æŸ¥
- [ ] 4. æ·»åŠ  `isServiceRunning` è¾…åŠ©æ–¹æ³•
- [ ] 5. åœ¨ `measurement_page.dart` ä¸­æ·»åŠ è¿æ¥çŠ¶æ€ç›‘å¬
- [ ] 6. ç¦ç”¨æœªè¿æ¥æ—¶çš„"å¼€å§‹æµ‹é‡"æŒ‰é’®
- [ ] 7. æ·»åŠ æµ‹é‡æ—¶é•¿é€‰æ‹©å¯¹è¯æ¡†
- [ ] 8. æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- [ ] 9. æµ‹è¯•å®Œæ•´æµç¨‹ï¼šæ‰«æ â†’ è¿æ¥ â†’ æµ‹é‡
- [ ] 10. éªŒè¯å´©æºƒæ˜¯å¦ä¿®å¤

---

## âœ… æµ‹è¯•æ­¥éª¤

1. **ç¼–è¯‘å¹¶è¿è¡Œåº”ç”¨**
   ```bash
   cd openring_flutter
   flutter run
   ```

2. **æµ‹è¯•æµç¨‹**
   - æ‰“å¼€åº”ç”¨
   - ç‚¹å‡»"æ‰«æè®¾å¤‡"
   - é€‰æ‹©æˆ’æŒ‡å¹¶è¿æ¥
   - ç­‰å¾…è¿æ¥æˆåŠŸæç¤º
   - è¿›å…¥æµ‹é‡é¡µé¢
   - ç‚¹å‡»"å¼€å§‹æµ‹é‡"
   - é€‰æ‹©æ—¶é•¿
   - è§‚å¯Ÿæ˜¯å¦è¿˜ä¼šå´©æºƒ

3. **æŸ¥çœ‹æ—¥å¿—**
   ```bash
   adb logcat | grep -E "OpenRing|BLEService|Flutter"
   ```

---

## ğŸš¨ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

å¦‚æœä¿®å¤åä»ç„¶å´©æºƒï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å®Œæ•´çš„å´©æºƒå †æ ˆ**ï¼ˆä» Logcatï¼‰
2. **ç‚¹å‡»"å¼€å§‹æµ‹é‡"å‰çš„æ—¥å¿—**ï¼ˆåŒ…å«è¿æ¥çŠ¶æ€ï¼‰
3. **BLEService çš„è¿è¡ŒçŠ¶æ€**
4. **æµ‹è¯•è®¾å¤‡ä¿¡æ¯**ï¼ˆAndroid ç‰ˆæœ¬ã€æ‰‹æœºå‹å·ï¼‰

ç„¶åæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥åˆ†æé—®é¢˜ã€‚

---

**æœ€åæ›´æ–°**: 2025-10-31






