# OpenRing Flutter

OpenRing 智能戒指 Flutter 应用

## 项目状态

✅ **已完成**:
- Flutter 项目结构创建
- pubspec.yaml 依赖配置
- Platform Channel 接口定义
- Freezed 数据模型 (BleEvent, Sample, RingFile)
- 数据源抽象层 (LiveBleDataSource, OfflineRecordingDataSource)
- VitalSignsProcessor Dart 版本（从 Java 迁移）
- 主要页面 UI 框架 (Dashboard, Measurement, History, Settings)

⏳ **待完成**:
- Android 原生 Platform Channel 实现 (Kotlin)
- 复制并集成 ChipletRing1.0.81.aar
- 运行 Freezed 代码生成
- 实时波形图表 CustomPainter
- 端到端测试
- 性能优化

## 快速开始

### 前提条件

1. 安装 Flutter SDK 3.24.x
   ```bash
   # Windows (使用 winget)
   winget install -e --id=FlutterTeam.FlutterSdk
   
   # 或从官网下载
   # https://docs.flutter.dev/get-started/install/windows
   ```

2. 验证安装
   ```bash
   flutter doctor
   ```

### 初始化项目

```bash
# 1. 进入项目目录
cd openring_flutter

# 2. 获取依赖
flutter pub get

# 3. 生成 Freezed 代码
flutter pub run build_runner build --delete-conflicting-outputs

# 4. 运行项目
flutter run
```

### 集成原生 AAR

```bash
# 复制 AAR 库
cp ../app/libs/ChipletRing1.0.81.aar android/app/libs/

# 复制 BLEService.java (暂时保留原生蓝牙逻辑)
cp ../app/src/main/java/com/tsinghua/openring/utils/BLEService.java \
   android/app/src/main/java/com/tsinghua/openring/
```

### 配置 Android Gradle

编辑 `android/app/build.gradle`:

```gradle
android {
    // ... 其他配置
    
    repositories {
        flatDir {
            dirs 'libs'
        }
    }
}

dependencies {
    // AAR 依赖
    implementation(name: 'ChipletRing1.0.81', ext: 'aar')
    
    // ... 其他依赖
}
```

## 项目结构

```
openring_flutter/
├── lib/
│   ├── main.dart                    # 应用入口
│   ├── router/
│   │   └── app_router.dart          # 路由配置
│   ├── pages/                       # 页面
│   │   ├── dashboard_page.dart
│   │   ├── measurement_page.dart
│   │   ├── history_page.dart
│   │   └── settings_page.dart
│   ├── models/                      # 数据模型 (Freezed)
│   │   ├── ble_event.dart
│   │   ├── sample.dart
│   │   └── ring_file.dart
│   ├── services/                    # 数据源
│   │   ├── sensor_data_source.dart
│   │   ├── live_ble_source.dart
│   │   └── offline_recording_source.dart
│   ├── processors/                  # 算法
│   │   └── vital_signs_processor.dart
│   ├── platform/                    # Platform Channel
│   │   └── ring_platform_interface.dart
│   └── providers/                   # Riverpod Providers (待实现)
├── android/
│   └── app/
│       ├── src/main/kotlin/         # Kotlin 原生代码 (待实现)
│       └── libs/                    # AAR 库 (待复制)
├── test/                            # 测试
├── pubspec.yaml                     # 依赖配置
└── README.md
```

## 核心设计

### 数据源抽象（统一在线/离线）

```dart
// 统一接口
abstract class SensorDataSource {
  Stream<List<Sample>> get sampleStream;
  Future<void> start(SourceConfig config);
  Future<void> stop();
}

// 三种实现
class LiveBleDataSource implements SensorDataSource { }       // 实时 BLE
class OfflineRecordingDataSource implements SensorDataSource { } // 戒指录制
class LocalFileDataSource implements SensorDataSource { }     // 本地回放
```

### 离线模式 8 状态管理

```dart
enum RecordingPhase {
  idle,              // 空闲
  scheduling,        // 发送启动命令
  recording,         // 戒指采集中（可断连）
  waitingDownload,   // 等待下载
  downloading,       // 下载中
  readyForPlayback,  // 准备回放
  playingBack,       // 回放中
}
```

### Platform Channel 通信

**Dart 侧** → **Kotlin 原生** → **现有 BLEService.java** → **AAR 库**

## 下一步

### 开发者需要完成的任务

1. **配置 Flutter 环境**
   - 安装 Flutter SDK
   - 配置 Android Studio / VSCode
   - 运行 `flutter doctor` 确保环境正确

2. **复制原生资源**
   ```bash
   cp ../app/libs/ChipletRing1.0.81.aar android/app/libs/
   ```

3. **实现 Platform Channel (Kotlin)**
   - 创建 `RingMethodChannel.kt`
   - 创建 `RingEventChannel.kt`
   - 连接现有 `BLEService.java`

4. **运行代码生成**
   ```bash
   flutter pub run build_runner build
   ```

5. **测试应用**
   ```bash
   flutter run
   ```

## 依赖说明

- **flutter_riverpod**: 状态管理
- **go_router**: 路由管理
- **freezed**: 数据模型代码生成
- **permission_handler**: 权限管理
- **fl_chart**: 图表库（波形绘制）

## 常见问题

### 1. Freezed 代码生成失败

```bash
# 清理并重新生成
flutter clean
flutter pub get
flutter pub run build_runner build --delete-conflicting-outputs
```

### 2. Platform Channel 调用失败

检查：
- Kotlin 代码是否正确注册 Channel
- Channel 名称是否匹配 (`ring/method`, `ring/events`)
- 原生依赖是否正确配置

### 3. AAR 库找不到

确保：
- AAR 文件在 `android/app/libs/` 目录
- `build.gradle` 中配置了 `flatDir` 仓库
- 依赖声明正确：`implementation(name: 'ChipletRing1.0.81', ext: 'aar')`

## 贡献

请参考 `FLUTTER_REFACTORING_ROADMAP.md` 了解详细的开发计划。

## 许可

同原 Android 项目。

