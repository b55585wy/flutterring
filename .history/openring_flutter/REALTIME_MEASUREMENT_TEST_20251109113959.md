# 实时测量功能测试指南

## 📋 功能概述

实时测量功能已实现，包括：
- ✅ 启动/停止在线测量
- ✅ 实时数据流解析（PPG×3, ACC×3, Gyro×3, Temp×3）
- ✅ 波形数据更新
- ✅ 样本计数统计
- ✅ 自动停止（可配置时长）

## 🧪 测试步骤

### 1. 准备工作
```bash
# 确保应用已编译
flutter run

# 或在 Android Studio 中运行
```

### 2. 连接设备
1. 启动应用
2. 在主页点击"扫描"按钮
3. 选择并连接戒指设备
4. 等待连接成功（状态变为"已连接"）

### 3. 开始测量
1. 切换到"测量"页面（底部导航第2个）
2. 点击"开始测量"按钮
3. 选择测量时长（30秒/1分钟/2分钟/5分钟/自定义）
4. 观察以下内容：

#### 预期结果：
- ✅ 按钮文字变为"停止测量"
- ✅ 样本计数开始增加
- ✅ 波形开始滚动显示
- ✅ 日志输出（见下方）

### 4. 观察日志

#### Kotlin 侧日志（MainActivity.kt）
```
========== 开始测量 ==========
时长: 30 秒
连接状态: true
测量状态: false
✅ 状态检查通过，准备发送命令
发送命令: C4
✅ 命令已发送
设置 30 秒后自动停止
========== 测量启动成功 ==========

收到实时数据包: seq=0, dataNum=25
收到实时数据包: seq=1, dataNum=25
...
```

#### Flutter 侧日志（measurement_page.dart）
```
🔵 Flutter Measurement: 开始测量，时长=30秒
🔵 Flutter Measurement: 测量状态已更新，_isRecording=true
🔵 Flutter Measurement: 收到样本批次 - 25 个样本, timestamp=1698765432000
🔵 Flutter Measurement: 第一个样本 - green=123456, red=234567, ir=345678
🔵 Flutter Measurement: 当前总样本数=25, 波形数据点=25
🔵 Flutter Measurement: 收到样本批次 - 25 个样本, timestamp=1698765433000
🔵 Flutter Measurement: 第一个样本 - green=123789, red=234890, ir=345901
🔵 Flutter Measurement: 当前总样本数=50, 波形数据点=50
...
```

### 5. 停止测量
1. 点击"停止测量"按钮
2. 或等待自动停止（时长到期）

#### 预期结果：
- ✅ 按钮文字变为"开始测量"
- ✅ 波形停止更新
- ✅ 日志显示停止命令

## 🔍 问题排查

### 问题1：点击"开始测量"后无反应
**可能原因**：
- 设备未连接
- 蓝牙服务未启动

**解决方案**：
1. 检查主页连接状态是否为"已连接"
2. 查看 Logcat 是否有错误信息
3. 尝试断开重连

### 问题2：没有收到数据（样本数不增加）
**可能原因**：
- 戒指未发送数据
- 数据包格式不匹配
- BLE 广播未注册

**解决方案**：
1. 检查 Logcat 是否有"收到实时数据包"日志
2. 如果有日志但无 Flutter 日志，检查 EventChannel 是否正常
3. 检查 `parseSamples` 方法的数据包格式

### 问题3：波形显示异常
**可能原因**：
- PPG 数据值异常
- 数据解析错误

**解决方案**：
1. 检查日志中的 green/red/ir 值是否合理（通常 > 10000）
2. 检查 `readUInt32LE` 方法是否正确
3. 对比原生 App 的数据值

### 问题4：测量无法停止
**可能原因**：
- 停止命令未发送
- 状态未更新

**解决方案**：
1. 检查 Logcat 是否有"停止在线测量"日志
2. 检查 `stopMeasurement` 方法实现
3. 尝试断开连接强制停止

## 📊 性能指标

### 正常指标：
- **采样率**: 25 Hz（每秒25个样本）
- **数据延迟**: < 100ms
- **UI 帧率**: >= 30 FPS
- **内存占用**: < 100 MB

### 监控方法：
```bash
# 查看日志
adb logcat | findstr /i "OpenRing Flutter"

# 监控内存
adb shell dumpsys meminfo com.tsinghua.openring_flutter

# 监控 CPU
adb shell top | findstr openring_flutter
```

## ✅ 验收标准

### 基础功能：
- [x] 可以启动测量
- [x] 可以停止测量
- [x] 样本计数正确增加
- [x] 波形实时更新
- [x] 自动停止功能正常

### 数据质量：
- [ ] PPG 数据值合理（> 10000）
- [ ] 波形连续无断点
- [ ] 采样率稳定（25 Hz）

### 异常处理：
- [x] 未连接时禁用开始按钮
- [x] 断连时自动停止测量
- [x] 错误提示友好

## 🚀 下一步

完成基础测量功能后，下一步是：
1. **集成生理指标算法**（HR/RR 计算）
2. **优化波形显示**（多通道、缩放、滚动）
3. **添加信号质量评估**
4. **实现离线录制功能**

## 📝 备注

- 当前实现使用 Java 算法（通过 AAR 库）
- 数据格式参考原生 App（每个样本 30 字节）
- 波形仅显示 Green 通道（可扩展为 3 通道）
- 最多缓存 500 个数据点（约 20 秒）

---

**测试日期**: 2024-11-01  
**测试人员**: [待填写]  
**测试结果**: [待填写]






