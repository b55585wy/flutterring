# M1 架构基线任务拆分

> 目标摘要：完成分层结构搭建、事件流稳定化、扫描流程重构，为后续功能开发奠定基础。

## 1. 工作包概览

| 编号 | 工作包 | 说明 | 负责人 | 预计用时 |
|------|--------|------|--------|----------|
| WP1 | 代码结构重整 | 建立 presentation/application/domain/infrastructure 目录；迁移现有文件 | 技术 | 1.5 天 |
| WP2 | 事件流重构 | `RingPlatform.eventStream` 改造为单例广播流；补充测试 | 技术 | 1 天 |
| WP3 | BLE 控制器初版 | 编写 `BleScanController`、`DeviceConnectionController`；暴露 Provider | 技术 | 2 天 |
| WP4 | Flutter UI 适配 | Dashboard 使用 Controller 状态；更新扫描、连接 UI | 技术 | 1.5 天 |
| WP5 | QA 验证与文档 | 真机验证扫描/连接流程；更新调试指南 | 技术/产品 | 1 天 |

## 2. 任务清单

### WP1 代码结构重整

- [ ] 创建 `lib/presentation`, `lib/application`, `lib/domain`, `lib/infrastructure` 目录。
- [ ] 将 `home_page.dart`, `measurement_page.dart`, `settings_page.dart` 移至 `presentation/dashboard`, `presentation/measurement`, `presentation/settings`。
- [ ] 将 `ble_event.dart`, `device_info.dart`, `sample.dart` 等 Freezed 模型迁至 `domain/models/`。
- [ ] 新建 `application/controllers/` 空目录，并放入 README 标注待实现内容。
- [ ] 更新 `docs/software_architecture.md` 中的引用路径。

### WP2 事件流重构

- [ ] 将 `RingPlatform.eventStream` 改造为 `asBroadcastStream()` 单例（已在现有代码实现，可回顾确认）。
- [ ] 添加单元测试（使用 `TestEventChannel` 模拟）验证多订阅不会丢事件。
- [ ] 编写调试指南，说明如何在 logcat 观察 `deviceFound`。

### WP3 BLE 控制器初版

- [ ] 定义 `BleScanController`（含 `startScan`, `stopScan`, `devicesStream`）。
- [ ] 定义 `DeviceConnectionController`（含 `connect`, `disconnect`, `connectionState`）。
- [ ] 创建对应的 Riverpod Provider，提供应用层访问接口。
- [ ] 为控制器编写基础测试或伪代码验证。

### WP4 Flutter UI 适配

- [ ] Dashboard 页面通过 Provider 获取扫描列表，不再直接操作 `_foundDevices`。
- [ ] 扫描按钮调用 `BleScanController`；连接按钮调用 `DeviceConnectionController`。
- [ ] 更新日志输出为统一格式（可选）。
- [ ] 确认设置页读取的连接状态来源于 Controller。

### WP5 QA 验证与文档

- [ ] 真机测试：扫描 → 连接 → 断开 → 重新扫描，确保流程稳定。
- [ ] 记录测试流程与结果，写入 `research/testing_logs.md`（待创建）。
- [ ] 更新 `docs/software_architecture.md` 的 “M1 Scope” 小节（若需要）。
- [ ] 会议纪要：在 `meetings/` 文件更新执行情况。

## 3. 进度跟踪

- 建议使用简单待办（如此文档 + 勾选）或在仓库 README 中维护进度。
- 每日更新：
  - 完成任务打勾，并写上日期/备注。
  - 发现阻塞则在文档底部“阻塞项”栏记录。

## 4. 阻塞项（持续更新）

- _暂无_

## 5. 里程碑验收检查表

- [ ] 新分层结构在仓库中落地。
- [ ] 事件流多次订阅无冲突，Flutter 日志能看到 `BleScanController` 输出。
- [ ] Dashboard UI 使用 Controller 状态并可正常扫描、连接。
- [ ] 编写基础测试、调试文档。
- [ ] 产品/技术确认 M2 进入条件。

## 6. 推荐执行顺序

1. **结构调整 (WP1)**：先完成目录划分与文件迁移，确保后续开发有统一入口。
2. **事件流验证 (WP2)**：在新结构下复查并测试事件流广播，避免再出现订阅冲突。
3. **控制器开发 (WP3)**：实现扫描与连接控制器，提供状态流给 UI 使用。
4. **UI 改造 (WP4)**：按照 `ux/m1_ui_spec.md` 的规格，把 Dashboard/弹窗等页面切换到 Controller 数据源。
5. **测试与文档 (WP5)**：真机验证、更新调试指南，把反馈写入 `research/testing_logs.md`。

> 每完成一个步骤，可在此文档勾选对应任务并记录日期。


