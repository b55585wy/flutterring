# M1 架构基线任务拆分

> 目标摘要：完成分层结构搭建、事件流稳定化、扫描流程重构，为后续功能开发奠定基础。

## 1. 工作包概览

| 编号 | 工作包 | 说明 | 负责人 | 预计用时 |
|------|--------|------|--------|----------|
| WP1 | 代码结构重整 | 建立 presentation/application/domain/infrastructure 目录；迁移现有文件 | 技术 | 1.5 天 |
| WP2 | 事件流重构 | `RingPlatform.eventStream` 改造为单例广播流；补充测试 | 技术 | 1 天 |
| WP3 | BLE 控制器初版 | 编写 `BleScanController`、`DeviceConnectionController`；暴露 Provider | 技术 | 2 天 |
| WP4 | Flutter UI 适配 | Dashboard 使用 Controller 状态；更新扫描、连接 UI | 技术 | 1.5 天 |
| WP5 | QA 验证与文档 | 真机验证扫描/连接流程；更新调试指南 | 技术/产品 | 1 天 |

## 2. 任务清单

### WP1 代码结构重整

- [x] 创建 `lib/presentation`, `lib/application`, `lib/domain`, `lib/infrastructure` 目录。（2025-11-03）
- [x] 将 `home_page.dart`, `measurement_page.dart`, `settings_page.dart` 移至 `presentation/dashboard`, `presentation/measurement`, `presentation/settings`。（2025-11-03）
- [x] 将 `ble_event.dart`, `device_info.dart`, `sample.dart` 等 Freezed 模型迁至 `domain/models/`。（2025-11-03）
- [x] 新建 `application/controllers/` 空目录，并放入 README 标注待实现内容。（2025-11-03）
- [x] 更新 `docs/software_architecture.md` 中的引用路径。（2025-11-03）

### WP2 事件流重构

- [x] 将 `RingPlatform.eventStream` 改造为 `asBroadcastStream()` 单例。（2025-11-03）
- [x] 添加单元测试（使用 `MethodChannel` mock + `handlePlatformMessage`）验证多订阅不会丢事件。（见 `openring_flutter/test/infrastructure/ring_platform_event_stream_test.dart`，2025-11-03）
- [x] 编写调试指南，说明如何在 logcat 观察 `deviceFound`。（见 `smartring/research/testing_logs.md`，2025-11-03）

### WP3 BLE 控制器初版

- [x] 定义 `BleScanController`（含 `startScan`, `stopScan`, 设备列表状态）。
- [x] 定义 `DeviceConnectionController`（含 `connect`, `disconnect`, 连接状态）。
- [x] 创建对应的 Riverpod Provider，提供应用层访问接口。
- [x] 为控制器编写基础测试（见 `test/application/*_controller_test.dart`）。

### WP4 Flutter UI 适配

- [x] Dashboard 页面通过 Provider 获取扫描列表，不再直接操作 `_foundDevices`。（2025-11-03）
- [x] 扫描按钮调用 `BleScanController`；连接按钮调用 `DeviceConnectionController`。（2025-11-03）
- [ ] 更新日志输出为统一格式（可选）。
- [x] 确认设置页读取的连接状态来源于 Controller。（2025-11-03）

### WP5 QA 验证与文档

- [ ] 真机测试：扫描 → 连接 → 断开 → 重新扫描，确保流程稳定。
- [x] 记录测试流程与结果，写入 `research/testing_logs.md`。（2025-11-03 自动化用例）
- [ ] 更新 `docs/software_architecture.md`