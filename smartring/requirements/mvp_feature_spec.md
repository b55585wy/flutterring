# SmartRing 功能需求梳理（面向科研数据采集）

## 1. 需求说明摘要

本文件聚焦 SmartRing MVP 阶段必须交付的功能，以支撑科研人员进行单/少量设备的实验数据采集与分析。所有需求均与 `docs/software_architecture.md` 中的模块相对应，方便后续联动开发。

## 2. 功能分组与优先级

| 模块 | 功能名称 | 说明 | 优先级 |
|------|----------|------|--------|
| 设备接入 | F1. 扫描附近戒指 | 请求权限后扫描，呈现设备列表，展示名称/MAC/RSSI | P0 |
| 设备接入 | F2. 设备连接/断开 | 支持手动连接、断开，展示当前状态与错误 | P0 |
| 实时监测 | F3. 实时指标显示 | 显示心率、呼吸率、信号质量（更新频率 ≤1s） | P0 |
| 实时监测 | F4. 原始波形预览 | 基于 PPG green 数据绘制实时波形（长度 ~30s） | P1 |
| 数据记录 | F5. 在线测量启动/停止 | 用户指定时长（预设 30s/60s/120s/自定义），控制测量状态 | P0 |
| 数据记录 | F6. 样本缓存 | 测量期间缓存原始样本（PPG、加速度、温度等） | P0 |
| 数据导出 | F7. 本地导出 | 测量结束后导出 CSV/JSON，命名含时间戳/实验ID | P0 |
| 实验管理 | F8. 受试者/实验笔记 | 记录受试者编号、实验标签、备注（可选） | P1 |
| 诊断支持 | F9. 连接日志与错误提示 | UI 显示错误、支持导出日志（近期会话） | P1 |
| 系统设置 | F10. 权限与偏好 | 权限状态提示、默认测量时长、数据保存路径 | P1 |
| 设备信息 | F11. 设备信息/电量 | 显示固件版本、电量，提示充电需求 | P1 |

- **优先级说明**：P0 = MVP 必须交付；P1 = MVP 可选但强烈建议；P2 = 后续迭代。
- 本次梳理重点详述 P0 功能，同时草拟主要 P1 功能的需求，为后续扩展做准备。

## 3. 用户故事与验收标准（P0）

### F1 扫描附近戒指

- **用户故事**：科研助理打开应用，点击“扫描”，期望在 15 秒内看到附近可用的戒指标识，并按信号强度排序，未被重复列出。
- **验收标准**：
  1. 首次使用时若缺少权限，弹出权限说明与请求。
  2. 扫描列表展示：`设备名称 / MAC / RSSI (dBm)`。
  3. 相同 MAC 地址只出现一次；支持手动刷新（重新扫描）。
  4. 扫描超时自动停止（默认 15s），并提示“扫描完成”。

### F2 设备连接/断开

- **用户故事**：研究员从列表选择设备后，应用提示连接进度/成功/失败。需要在顶部状态栏展示连接状态，并可随时断开。
- **验收标准**：
  1. 正在连接时展示 Loading，成功后显示“已连接 + 设备名/MAC”。
  2. 异常（超时/权限/服务不可用）给出错误码与文案。
  3. 断开时先停止测量（若正在进行），再释放连接。
  4. 断开后列表仍可重新扫描/连接。

### F3 实时指标显示

- **用户故事**：实验进行时，研究员需要即时看到心率、呼吸率、信号质量，以判断佩戴是否正确。
- **验收标准**：
  1. 心率、呼吸率更新频率 ≤ 1s；无数据时显示 `--`。
  2. 信号质量使用图标或颜色标识（优秀/良好/一般/差/无信号）。
  3. 指标面板在断开连接后自动清零。

### F5 在线测量启动/停止

- **用户故事**：研究员选择测量时长并开始采集；可随时提前停止。需要看到倒计时/进度提示。
- **验收标准**：
  1. 预设时长按钮（30s/60s/120s），支持自定义输入。
  2. 测量进行中显示剩余时间，支持“停止”按钮。
  3. 测量结束（倒计时归零或手动停止）后，自动触发数据保存流程。

### F6 样本缓存

- **用户故事**：测量期间所有原始样本需缓存到本地，以备导出或离线分析。
- **验收标准**：
  1. 样本结构包括时间戳、PPG（R/G/IR）、ACC（三轴）、GYRO（三轴）、温度、信号质量。
  2. 缓存格式采用可序列化数据结构（JSON/二进制），临时存储于本地沙盒。
  3. 缓存大小与时长有上限提示，避免无限增长（默认 ≤ 30 分钟，P1 计划扩展至 8 小时，通过分段写盘与自动续录实现）。

### F7 本地导出

- **用户故事**：测量完成后，我需要一键导出 CSV 或 JSON 文件，用于后续在 Python/R 中分析。
- **验收标准**：
  1. 导出格式可选：CSV（按字段列）、JSON（数组）。
  2. 文件命名规范：`YYYYMMDD_HHMMSS_[SubjectID]_[SessionID].csv`。
  3. 导出完成后提示保存路径；若失败提供重试与错误日志。
  4. 可选：一键复制导出路径或分享。


## 4. P1 功能草案

### F4 原始波形预览

- 实时绘制最近 30 秒的 PPG green 数据，提供信号质量直观反馈。
- 支持暂停/恢复可视化，采样频率根据设备能力调整，目标刷新率 ≥ 10 FPS。

### F8 受试者/实验笔记

- 在测量前填写受试者 ID、实验场景、备注；测量结果与元数据绑定存储与导出。
- UI 必须简单（最多 3 个输入），避免现场操作复杂。

### F9 连接日志与错误提示

- 在设置/调试页展示最近 20 条连接事件（时间、状态、错误码），支持导出日志。
- 仅在研究员角色使用，普通操作界面仅弹出必要提示。

### F10 权限与偏好

- 设置页集中展示权限状态，提供引导重新授权。
- 可设置默认测量时长、导出格式、数据保存目录。

### F11 设备信息/电量

- 显示当前连接设备的固件版本、电量百分比、上次连接时间。
- 电量低于阈值（20%）时在主页提示。


## 5. 接口与数据规范（部分）

- **原始样本 JSON 结构**：
  ```json
  {
    "timestamp": 1730611200123,
    "ppg": { "green": 123456, "red": 113456, "ir": 98765 },
    "acc": { "x": 12, "y": -5, "z": 1024 },
    "gyro": { "x": 21, "y": -18, "z": 5 },
    "temp": { "skin": 34.2 },
    "signalQuality": "good"
  }
  ```
- 对应 CSV 表头：`timestamp,ppg_green,ppg_red,ppg_ir,acc_x,acc_y,acc_z,gyro_x,gyro_y,gyro_z,temp_skin,signal_quality`


## 6. 非功能性需求

- **性能**：实时指标延迟 ≤ 1s；波形绘制帧率 ≥ 10 FPS（P1）。
- **可靠性**：扫描/连接失败时有明确提示，支持重试；测量数据写盘前有完整性校验。
- **可用性**：MVP 目标用户具备科研背景但未必熟悉 BLE，UI 提示需清晰。
- **安全性**：数据导出默认存储在本地加密沙盒；提供删除数据选项。
- **可维护性**：功能与 `docs/software_architecture.md` 模块一一对应，确保可测试性。


## 7. 依赖与风险

- 依赖硬件提供稳定的传感器数据与 SDK；若协议变更需同步更新。
- Android 权限策略随版本变化，需持续维护。
- 大体积数据导出可能受限于设备存储或写盘速度，需要监控并优化。


## 8. 后续动作

1. 与技术团队评审 F1~F7 需求，可行性确认与工作量估算。
2. 在 `roadmap/` 制定对应里程碑与发布计划。
3. 为 P1 功能编写更细的用户故事与原型说明，供后续迭代使用。


